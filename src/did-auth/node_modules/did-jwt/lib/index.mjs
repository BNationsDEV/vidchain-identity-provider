import{sha256 as r}from"js-sha256";import{keccak_256 as e}from"js-sha3";import{ec as n}from"elliptic";import t from"tweetnacl";import{encode as o}from"@stablelib/utf8";import{Buffer as i}from"buffer";import a from"uport-base64url";function u(e){return i.from(r.arrayBuffer(e))}function c(r){return"0x"+(n=i.from(r.slice(2),"hex"),i.from(e.arrayBuffer(n))).slice(-20).toString("hex");var n}var f=new n("secp256k1");function s(r,e){return void 0===e&&(e=64),r.length===e?r:"0".repeat(e-r.length)+r}function l(r){var e=f.keyFromPrivate(r);return function(r){try{var n=e.sign(u(r)),t=n.s,o=n.recoveryParam;return Promise.resolve({r:s(n.r.toString("hex")),s:s(t.toString("hex")),recoveryParam:o})}catch(r){return Promise.reject(r)}}}function h(r){return new Uint8Array(Array.prototype.slice.call(Buffer.from(r,"base64"),0))}function d(r){var e=h(r);return function(r){try{var n=o(r),u=t.sign.detached(n,e),c=a.encode(i.from(u));return Promise.resolve(c)}catch(r){return Promise.reject(r)}}}var v=new n("secp256k1");function p(r,e){void 0===e&&(e=!1);var n=a.toBuffer(r);if(n.length!==(e?65:64))throw new Error("wrong signature length");var t={r:n.slice(0,32).toString("hex"),s:n.slice(32,64).toString("hex")};return e&&(t.recoveryParam=n[64]),t}function m(r,e,n){var t;if(e.length>86)t=[p(e,!0)];else{var o=p(e,!1);t=[Object.assign({},o,{recoveryParam:0}),Object.assign({},o,{recoveryParam:1})]}var i=t.map(function(e){var t=u(r),o=v.recoverPubKey(t,e,e.recoveryParam),i=o.encode("hex"),a=o.encode("hex",!0),f=c(i);return n.find(function(r){var e=r.publicKeyHex;return e===i||e===a||r.ethereumAddress===f})}).filter(function(r){return null!=r});if(0===i.length)throw new Error("Signature invalid for JWT");return i[0]}var y={ES256K:function(r,e,n){var t=u(r),o=p(e),i=n.filter(function(r){return void 0!==r.publicKeyHex}),a=n.filter(function(r){return void 0!==r.ethereumAddress}),c=i.find(function(r){var e=r.publicKeyHex;try{return v.keyFromPublic(e,"hex").verify(t,o)}catch(r){return!1}});if(!c&&a.length>0&&(c=m(r,e,a)),!c)throw new Error("Signature invalid for JWT");return c},"ES256K-R":m,Ed25519:function(r,e,n){var i=o(r),u=h(a.toBase64(e)),c=n.find(function(r){return t.sign.detached.verify(i,u,h(r.publicKeyBase64))});if(!c)throw new Error("Signature invalid for JWT");return c}};function g(r){var e=y[r];if(!e)throw new Error("Unsupported algorithm "+r);return e}function w(r){return"object"==typeof r&&"r"in r&&"s"in r}function b(r){return function(e,n){try{return Promise.resolve(n(e)).then(function(e){if(w(e))return function(n){var t=e.r,o=e.s,u=e.recoveryParam,c=i.alloc(r?65:64);if(i.from(t,"hex").copy(c,0),i.from(o,"hex").copy(c,32),r){if(void 0===u)throw new Error("Signer did not return a recoveryParam");c[64]=u}return a.encode(c)}();throw new Error("expected a signer function that returns a signature object instead of string")})}catch(r){return Promise.reject(r)}}}g.toSignatureObject=p;var E={ES256K:b(),"ES256K-R":b(!0),Ed25519:function(r,e){try{return Promise.resolve(e(r)).then(function(r){if(w(r))throw new Error("expected a signer function that returns a string instead of signature object");return r})}catch(r){return Promise.reject(r)}}},P=function(r,e){void 0===e&&(e={resolver:null,auth:null,audience:null,callbackUrl:null});try{if(!e.resolver)throw new Error("No DID resolver has been configured");var n=D(r),t=n.payload;return Promise.resolve(function(r,e,n,t){try{var o=j[e];if(!o||0===o.length)throw new Error("No supported signature types for algorithm "+e);return Promise.resolve(r.resolve(n)).then(function(r){if(!r)throw new Error("Unable to resolve DID document for "+n);var i=!t||(r.authentication||[]).map(function(r){return r.publicKey}),a=(r.publicKey||[]).filter(function(r){var e=r.type,n=r.id;return o.find(function(r){return r===e&&(!t||Array.isArray(i)&&i.indexOf(n)>=0)})});if(t&&(!a||0===a.length))throw new Error("DID document for "+n+" does not have public keys suitable for authenticationg user");if(!a||0===a.length)throw new Error("DID document for "+n+" does not have public keys for "+e);return{authenticators:a,issuer:n,doc:r}})}catch(r){return Promise.reject(r)}}(e.resolver,n.header.alg,t.iss,e.auth)).then(function(n){var o=n.doc,i=n.issuer;return Promise.resolve(A(r,n.authenticators)).then(function(n){var a=Math.floor(Date.now()/1e3);if(n){var u=a+J;if(t.nbf){if(t.nbf>u)throw new Error("JWT not valid before nbf: "+t.nbf)}else if(t.iat&&t.iat>u)throw new Error("JWT not valid yet (issued in the future) iat: "+t.iat);if(t.exp&&t.exp<=a-J)throw new Error("JWT has expired: exp: "+t.exp+" < now: "+a);if(t.aud){if(!e.audience&&!e.callbackUrl)throw new Error("JWT audience is required but your app address has not been configured");if(void 0===(Array.isArray(t.aud)?t.aud:[t.aud]).find(function(r){return e.audience===r||e.callbackUrl===r}))throw new Error("JWT audience does not match your DID or callback url")}return{payload:t,doc:o,issuer:i,signer:n,jwt:r}}})})}catch(r){return Promise.reject(r)}},S=function(r,e,n){var t=e.issuer,o=e.signer,i=e.alg,a=e.expiresIn;void 0===n&&(n={});try{if(!o)throw new Error("No Signer functionality has been configured");if(!t)throw new Error("No issuing DID has been configured");n.typ||(n.typ="JWT"),n.alg||(n.alg=i);var u={iat:Math.floor(Date.now()/1e3),exp:void 0};if(a){if("number"!=typeof a)throw new Error("JWT expiresIn is not a number");u.exp=(r.nbf||u.iat)+Math.floor(a)}var c=Object.assign({},u,r,{iss:t});return Promise.resolve(x(c,o,n))}catch(r){return Promise.reject(r)}},x=function(r,e,n){void 0===n&&(n={});try{n.alg||(n.alg=K);var t=[k(n),k(r)].join("."),o=function(r){var e=E[r];if(!e)throw new Error("Unsupported algorithm "+r);return e}(n.alg);return Promise.resolve(o(t,e)).then(function(r){return[t,r].join(".")})}catch(r){return Promise.reject(r)}},j={ES256K:["Secp256k1VerificationKey2018","Secp256k1SignatureVerificationKey2018","EcdsaPublicKeySecp256k1"],"ES256K-R":["Secp256k1VerificationKey2018","Secp256k1SignatureVerificationKey2018","EcdsaPublicKeySecp256k1"],Ed25519:["ED25519SignatureVerification"]},K="ES256K";function k(r){return a.encode(JSON.stringify(r))}var J=300;function D(r){if(!r)throw new Error("no JWT passed into decodeJWT");var e=r.match(/^([a-zA-Z0-9_-]+)\.([a-zA-Z0-9_-]+)\.([a-zA-Z0-9_-]+)$/);if(e)return{header:JSON.parse(a.decode(e[1])),payload:JSON.parse(a.decode(e[2])),signature:e[3],data:e[1]+"."+e[2]};throw new Error("Incorrect format JWT")}function A(r,e){Array.isArray(e)||(e=[e]);var n=D(r),t=n.data,o=n.signature;return g(n.header.alg)(t,o,e)}export{l as SimpleSigner,d as NaclSigner,P as verifyJWT,S as createJWT,D as decodeJWT,A as verifyJWS,x as createJWS,c as toEthereumAddress};
//# sourceMappingURL=index.mjs.map
